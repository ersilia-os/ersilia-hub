<div class="component-header">
    Model Management
</div>

<div class="component-toolbar">

    <div class="filters">
        <div class="filter">
            <mat-checkbox [(ngModel)]="filtersActiveOnly">Show Active Only</mat-checkbox>
        </div>

        <div class="filter">
            <mat-form-field class="search-string-filter">
                <mat-label>Model Search</mat-label>
                <input matInput type="text" [(ngModel)]="filtersSearchString">
                @if (filtersSearchString) {
                <button matSuffix matIconButton aria-label="Clear" (click)="filtersSearchString = undefined">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </mat-form-field>
        </div>

        <div class="spacer"></div>

        <div class="filter refresh">
            <div class="ersilia-button icon-only refresh" (click)="load()" [ngClass]="{'disabled': loading()}">
                @if(loading()) {
                <ersilia-loader [colour]="'#fffc'"></ersilia-loader>
                } @else {
                <mat-icon>refresh</mat-icon>
                }
            </div>
        </div>
    </div>

    <div class="actions">
        <div class="spacer"></div>
        <div class="action create">
            <div class="ersilia-button create" (click)="createModel()">
                <mat-icon>add</mat-icon>
                New Model
            </div>
        </div>
    </div>
</div>

<div class="models-container">
    <table mat-table [dataSource]="models()" class="mat-elevation-z8" [trackBy]="trackBy">
        @for (column of displayedColumns; track column) {
        <ng-container [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef>
                @if (column == 'actions') {
                <!-- hide actions header -->
                } @else {
                {{columnHeaders[column]}}
                }
            </th>

            <!-- 'enabled', 'id', 'description', 'resources', 'max_instances', 'exec_mode', 'actions' -->

            <td mat-cell *matCellDef="let element">
                @if (column == 'enabled') {
                <!-- TODO: on update call toggleModel() ?? -->
                <mat-checkbox [checked]="element[column]" (change)="toggleModel(element, $event.checked)"
                    [disabled]="loading()"></mat-checkbox>
                } @else if (column == 'id') {
                {{ element.id }}
                } @else if (column == 'description') {
                {{ element.details.description }}
                } @else if (column == 'resources') {
                <div class="resources">
                    <div class="resources-line">
                        <div class="resource">
                            CPU MIN : {{ element.details.k8s_resources.cpu_request }}m
                        </div>
                        <div class="resource">
                            CPU MAX : {{ element.details.k8s_resources.cpu_limit }}m
                        </div>
                    </div>
                    <div class="resources-line">
                        <div class="resource">
                            MEM MIN : {{ element.details.k8s_resources.memory_request }}Mi
                        </div>
                        <div class="resource" [ngClass]="{'warn': element.details.disable_memory_limit}">
                            @if (element.details.disable_memory_limit) {
                            <s>MEM MAX : {{ element.details.k8s_resources.memory_limit }}Mi</s>
                            } @else {
                            MEM MAX : {{ element.details.k8s_resources.memory_limit }}Mi
                            }
                        </div>
                    </div>
                </div>
                } @else if (column == 'max_instances') {
                {{ element.details.max_instances }}
                } @else if (column == 'exec_mode') {
                <div class="mode"
                    [ngClass]="{'sync': element.details.execution_mode === 'SYNC', 'async': element.details.execution_mode === 'ASYNC' }">
                    {{ element.details.execution_mode }}
                </div>
                } @else if (column == 'image_tag') {
                {{ element.details.image_tag }}
                } @else if (column == 'cache_enabled') {
                <mat-checkbox [checked]="element.details.cache_enabled" [disabled]="true"></mat-checkbox>
                } @else if (column == 'actions') {
                <div class="action-button" (click)="editModel(element)">
                    <mat-icon>create</mat-icon>
                </div>
                }
            </td>
        </ng-container>
        }

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
</div>
